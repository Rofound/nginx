# author Liu Pei <1353590214@qq.com>
# since 2020.11.5
# nginx-1.18.0


server {
  listen 	10003;
	include myfams.env;
	# 新的主服务前端页面打包地址
	location / {
		#root  F:/lp-workspace/gitlab/newframework/dist/;
		root $mainservice;
		rewrite ^/.*/$ / last; # Redirect everything to / (ex index.html) and let the JS router take care of the rest
		rewrite ^([^.]*[^/])$ $1/ permanent; # Force trailing slash
	}
	# 转发至后端主服务
	location /myfams {
		#proxy_pass  http://localhost:8080/myfams;
		proxy_pass $backendmainservice;
		proxy_set_header Host  $Host;
		proxy_set_header X-Real-IP  $remote_addr;
		proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;
		proxy_http_version  1.1;
		proxy_set_header Upgrade  $http_upgrade; # websocket 等升级http协议
		proxy_set_header Connection  "upgrade"; # websocket 等升级http协议
		proxy_send_timeout  300; # 秒
		proxy_read_timeout  300; # 秒
		proxy_connect_timeout  300; # 秒
	}
}

# 别名方式配置qiankun微服务
server {
  listen  10001;
	location /qiankun/ {
		#alias		E:/nginx-1.18.0/myfams/;
		alias		$myfamsmicroservicedir;

		# TODO. 添加 websocket 支持

		# 添加 cros
		add_header 'Access-Control-Allow-Origin' *;
		add_header 'Access-Control-Allow-Credentials' 'true';
		add_header 'Access-Control-Allow-Methods' 'GET,POST,OPTIONS,PUT,DELETE';
		add_header 'Access-Control-Allow-Headers' 'Content-Type, x-requested-with, X-Custom-Header, Authorization';
		add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range'; # 提供给客户端访问的响应头
		if ($request_method = 'OPTIONS') {
			# 预检命令的缓存， 如果不缓存每次会发送两次请求
			add_header 'Access-Control-Max-Age'  1728000;
			add_header 'Content-Type' 'text/plain; charset=utf-8';
			add_header 'Content-Length'  0;
			# 不返回主体内容
			return  204;
		}
		
	}
}